"""
–°–µ—Ä–≤–∏—Å –¥–µ-–±–æ–ª—Ç–æ–≤–Ω–∏ –¥–ª—è SuperWhisper
–í—ã—á–∏—â–∞–µ—Ç –º–µ–∂–¥–æ–º–µ—Ç–∏—è, –ø–æ–≤—Ç–æ—Ä—ã –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
"""

import logging
import re
from typing import Dict, List, Set


class DebloatService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ –æ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π"""

    def __init__(self, config=None):
        self.logger = logging.getLogger(__name__)
        self.config = config

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        self.enabled = True
        self.aggressive_mode = False  # –î–ª—è —Å–∏–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
        self.quiet_mode = True  # –¢–∏—Ö–∏–π —Ä–µ–∂–∏–º –±–µ–∑ –ª–æ–≥–æ–≤

        if config and hasattr(config, 'debloat'):
            debloat_config = config.debloat
            self.enabled = debloat_config.get('enabled', True)
            self.aggressive_mode = debloat_config.get('aggressive_mode', False)

        # –ú–µ–∂–¥–æ–º–µ—Ç–∏—è –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        self.filler_words = {
            # –ë–∞–∑–æ–≤—ã–µ –º–µ–∂–¥–æ–º–µ—Ç–∏—è
            '–Ω—É', '–≤–æ—Ç', '—Ç–∏–ø–∞', '–∫–∞–∫ –±—ã', '–≤ –æ–±—â–µ–º', '–≤ –æ–±—â–µ–º-—Ç–æ',
            '—Ç–∞–∫ —Å–∫–∞–∑–∞—Ç—å', '–ø–æ–Ω–∏–º–∞–µ—à—å', '–∑–Ω–∞–µ—à—å', '—Å–ª—É—à–∞–π', '—Å–º–æ—Ç—Ä–∏',
            '–∫–æ—Ä–æ—á–µ', '–≤ —Å–º—ã—Å–ª–µ', '–≤–æ—Ç —Ç–∞–∫', '–≤–æ—Ç —ç—Ç–æ', '–≤–æ—Ç –æ–Ω–æ',
            '–≤–æ—Ç —á—Ç–æ', '–≤–æ—Ç –∫–∞–∫', '–≤–æ—Ç –ø–æ—á–µ–º—É', '–≤–æ—Ç –∑–∞—á–µ–º',

            # –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            '–≤–æ–Ω —Ç–æ—Ç', '–≤–æ–Ω —Ç–∞', '–≤–æ–Ω —Ç–æ', '–≤–æ–Ω —Ç–µ',
            '–≤–æ—Ç —Ç–æ—Ç', '–≤–æ—Ç —Ç–∞', '–≤–æ—Ç —Ç–æ', '–≤–æ—Ç —Ç–µ',
            '—Ç–∞–º —Ç–æ—Ç', '—Ç–∞–º —Ç–∞', '—Ç–∞–º —Ç–æ', '—Ç–∞–º —Ç–µ',

            # –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ —É—Å–∏–ª–∏—Ç–µ–ª–∏
            '–æ—á–µ–Ω—å-–æ—á–µ–Ω—å', '–ø—Ä–æ—Å—Ç–æ-–ø—Ä–æ—Å—Ç–æ', '—Å–æ–≤—Å–µ–º-—Å–æ–≤—Å–µ–º',
            '–∞–±—Å–æ–ª—é—Ç–Ω–æ', '–ø–æ–ª–Ω–æ—Å—Ç—å—é', '—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ',

            # –ü–∞—Ä–∞–∑–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–≤–∞
            '—ç-—ç', '—ç-—ç-—ç', '–º–º–º', '–≥–º–º', '—ç—ç—ç', '–∞-–∞', '–∞-–∞-–∞',

            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            '–≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ', '–≤ —Ü–µ–ª–æ–º', '–≤ –∏—Ç–æ–≥–µ', '–≤ –∫–æ–Ω—Ü–µ –∫–æ–Ω—Ü–æ–≤',
            '–≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ', '–≤ –ª—é–±–æ–º', '–≤ –æ–±—â–µ–º', '–≤ –æ—Å–Ω–æ–≤–Ω–æ–º',
            '–≤ —á–∞—Å—Ç–Ω–æ—Å—Ç–∏', '–≤ —á–∞—Å—Ç–Ω–æ—Å—Ç–∏', '–≤ —Å–≤—è–∑–∏', '–≤ —Å–≤—è–∑–∏ —Å',
            '–≤ —Ç–æ–º —á–∏—Å–ª–µ', '–≤ —Ç–æ –≤—Ä–µ–º—è', '–≤ —Ç–æ –∂–µ –≤—Ä–µ–º—è',
            '–≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å', '–≤ –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—á–µ—Ä–µ–¥—å',

            # –ú–µ–∂–¥–æ–º–µ—Ç–∏—è —Ç–∏–ø–∞ "—ç—ç—ç", "–º–º–º" –≤ —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞—Ü–∏—è—Ö
            '—ç', '—ç-—ç', '—ç-—ç-—ç', '—ç-—ç-—ç-—ç', '—ç-—ç-—ç-—ç-—ç',
            '–º–º', '–º–º–º', '–º–º–º–º', '–º–º–º–º–º',
            '–∞', '–∞-–∞', '–∞-–∞-–∞', '–∞-–∞-–∞-–∞',
            '–≥–º', '–≥–º–º', '–≥–º–º–º',

            # –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞
            '–∑–Ω–∞—á–∏—Ç', '–∏—Ç–∞–∫', '—Å—Ç–∞–ª–æ –±—ã—Ç—å', '—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ',
            '—Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º', '–∏–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏', '–¥—Ä—É–≥–∏–º–∏ —Å–ª–æ–≤–∞–º–∏',
            '–ø–æ–ø—Ä–æ—Å—Ç—É –≥–æ–≤–æ—Ä—è', '–ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏',

            # –§—Ä–∞–∑—ã-–ø–∞—Ä–∞–∑–∏—Ç—ã
            '–Ω—É –≤–æ—Ç', '–Ω—É —á—Ç–æ', '–Ω—É –∫–∞–∫', '–Ω—É –¥–∞', '–Ω—É –Ω–µ—Ç',
            '–≤–æ—Ç –≤–∏–¥–∏—à—å', '–≤–æ—Ç —Å–º–æ—Ç—Ä–∏', '–≤–æ—Ç —Å–ª—É—à–∞–π',
            '–∑–Ω–∞–µ—à—å –ª–∏', '–ø–æ–Ω–∏–º–∞–µ—à—å –ª–∏', '–≤–∏–¥–∏—à—å –ª–∏'
        }

        # –§—Ä–∞–∑—ã –¥–ª—è –∑–∞–º–µ–Ω—ã
        self.phrase_replacements = {
            # –£–¥–∞–ª–µ–Ω–∏–µ –º–µ–∂–¥–æ–º–µ—Ç–∏–π
            r'\b–Ω—É\b': '',
            r'\b–≤–æ—Ç\b': '',
            r'\b—Ç–∏–ø–∞\b': '',
            r'\b–∫–∞–∫ –±—ã\b': '',
            r'\b–≤ –æ–±—â–µ–º\b': '',
            r'\b–≤ –æ–±—â–µ–º-—Ç–æ\b': '',
            r'\b—Ç–∞–∫ —Å–∫–∞–∑–∞—Ç—å\b': '',
            r'\b–ø–æ–Ω–∏–º–∞–µ—à—å\b': '',
            r'\b–∑–Ω–∞–µ—à—å\b': '',
            r'\b–∫–æ—Ä–æ—á–µ –≥–æ–≤–æ—Ä—è\b': '–ø—Ä–æ—â–µ —Å–∫–∞–∑–∞—Ç—å',
            r'\b–∫–æ—Ä–æ—á–µ\b': '',
            r'\b–≤ —Å–º—ã—Å–ª–µ\b': '',
            r'\b–≤–æ—Ç —Ç–∞–∫\b': '',
            r'\b–≤–æ—Ç —ç—Ç–æ\b': '',
            r'\b–≤–æ—Ç –æ–Ω–æ\b': '',
            r'\b–≤–æ—Ç —á—Ç–æ\b': '',
            r'\b–≤–æ—Ç –∫–∞–∫\b': '',
            r'\b–≤–æ—Ç –ø–æ—á–µ–º—É\b': '',
            r'\b–≤–æ—Ç –∑–∞—á–µ–º\b': '',

            # –ó–∞–º–µ–Ω—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
            r'\b–≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ\b': '',
            r'\b–≤ —Ü–µ–ª–æ–º\b': '',
            r'\b–≤ –∏—Ç–æ–≥–µ\b': '',
            r'\b–≤ –∫–æ–Ω—Ü–µ –∫–æ–Ω—Ü–æ–≤\b': '–≤ –∏—Ç–æ–≥–µ',
            r'\b–≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ\b': '–≤—Å–µ —Ä–∞–≤–Ω–æ',
            r'\b–≤ –æ–±—â–µ–º\b': '',
            r'\b–≤ –æ—Å–Ω–æ–≤–Ω–æ–º\b': '',
            r'\b–≤ —á–∞—Å—Ç–Ω–æ—Å—Ç–∏\b': '',

            # –£–ª—É—á—à–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫
            r'\b–∑–Ω–∞—á–∏—Ç\b': '',
            r'\b–∏—Ç–∞–∫\b': '',
            r'\b—Å—Ç–∞–ª–æ –±—ã—Ç—å\b': '',
            r'\b—Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º\b': '',
            r'\b–∏–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏\b': '–ø—Ä–æ—â–µ –≥–æ–≤–æ—Ä—è',
            r'\b–¥—Ä—É–≥–∏–º–∏ —Å–ª–æ–≤–∞–º–∏\b': '–∏–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏',
            r'\b–ø–æ–ø—Ä–æ—Å—Ç—É –≥–æ–≤–æ—Ä—è\b': '–ø—Ä–æ—â–µ –≥–æ–≤–æ—Ä—è',
            r'\b–ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏\b': '–ø—Ä–æ—â–µ –≥–æ–≤–æ—Ä—è',

            # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∑–∞–º–µ–Ω—ã –¥–ª—è —Ç–µ—Ä–º–∏–Ω–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            r'\b–≥–∏–¥ –∏–≥–Ω–æ—Ä\b': '.gitignore',
            r'\b–∫–∏—Ç –∏–≥–Ω–æ—Ä\b': '.gitignore',
            r'\bgit ignore\b': '.gitignore',
            r'\bredmi\b': 'README.md',
            r'\b—Ä–∏–¥–º–∏\b': 'README.md',
            r'\b–ø–∏—Ç–æ–Ω\b': 'Python',
            r'\b–¥–∂–∞–≤–∞\b': 'Java',
            r'\b–¥–∂—Å\b': 'JavaScript',
            r'\b–¥–∂–∞–≤–∞—Å–∫—Ä–∏–ø—Ç\b': 'JavaScript'
        }

        # –≠—Ö–æ-–ø–æ–≤—Ç–æ—Ä—ã (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å–ª–æ–≤–∞ –ø–æ–¥—Ä—è–¥)
        self.echo_pattern = r'\b(\w+)\s+\1\b'

        # –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        self._compile_patterns()

        self.logger.info(f"üßπ DebloatService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: {len(self.filler_words)} —Å–ª–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏")

    def _compile_patterns(self):
        """–ö–æ–º–ø–∏–ª—è—Ü–∏—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
        self.compiled_patterns = {}

        # –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –º–µ–∂–¥–æ–º–µ—Ç–∏–π
        filler_pattern = r'\b(?:' + '|'.join(re.escape(word) for word in self.filler_words) + r')\b'
        self.compiled_patterns['fillers'] = re.compile(filler_pattern, re.IGNORECASE)

        # –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è —ç—Ö–æ-–ø–æ–≤—Ç–æ—Ä–æ–≤
        self.compiled_patterns['echo'] = re.compile(self.echo_pattern, re.IGNORECASE)

    def process_text(self, text: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç, —É–¥–∞–ª—è—è —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏"""
        if not self.enabled or not text:
            return text

        try:
            original_length = len(text)

            # –®–∞–≥ 1: –£–¥–∞–ª–µ–Ω–∏–µ –º–µ–∂–¥–æ–º–µ—Ç–∏–π
            text = self._remove_fillers(text)

            # –®–∞–≥ 2: –£–¥–∞–ª–µ–Ω–∏–µ —ç—Ö–æ-–ø–æ–≤—Ç–æ—Ä–æ–≤
            text = self._remove_echo_repeats(text)

            # –®–∞–≥ 3: –û—á–∏—Å—Ç–∫–∞ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
            text = self._cleanup_formatting(text)

            # –®–∞–≥ 4: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            if self.aggressive_mode:
                text = self._aggressive_cleanup(text)

            final_length = len(text)
            removed_chars = original_length - final_length

            if removed_chars > 0 and not self.quiet_mode:
                self.logger.debug(f"üßπ –î–µ-–±–æ–ª—Ç–æ–≤–Ω—è: —É–¥–∞–ª–µ–Ω–æ {removed_chars} —Å–∏–º–≤–æ–ª–æ–≤")

            return text

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –¥–µ-–±–æ–ª—Ç–æ–≤–Ω–∏: {e}")
            return text

    def _remove_fillers(self, text: str) -> str:
        """–£–¥–∞–ª—è–µ—Ç –º–µ–∂–¥–æ–º–µ—Ç–∏—è –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏"""
        try:
            # –°–ù–ê–ß–ê–õ–ê –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ—Ä–∞–∑—ã (—á—Ç–æ–±—ã "–∫–æ—Ä–æ—á–µ –≥–æ–≤–æ—Ä—è" –Ω–µ —Å—Ç–∞–ª–æ "–≥–æ–≤–æ—Ä—è")
            for pattern, replacement in self.phrase_replacements.items():
                if replacement:  # –¢–æ–ª—å–∫–æ –¥–ª—è —Ñ—Ä–∞–∑ —Å –∑–∞–º–µ–Ω–æ–π, –Ω–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                    text = re.sub(pattern, replacement, text, flags=re.IGNORECASE)

            # –ü–û–¢–û–ú —É–¥–∞–ª—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –º–µ–∂–¥–æ–º–µ—Ç–∏—è
            text = self.compiled_patterns['fillers'].sub('', text)

            # –ò —Ñ—Ä–∞–∑—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–±–µ–∑ –∑–∞–º–µ–Ω—ã)
            for pattern, replacement in self.phrase_replacements.items():
                if not replacement:  # –¢–æ–ª—å–∫–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                    text = re.sub(pattern, replacement, text, flags=re.IGNORECASE)

            return text

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ–∂–¥–æ–º–µ—Ç–∏–π: {e}")
            return text

    def _remove_echo_repeats(self, text: str) -> str:
        """–£–¥–∞–ª—è–µ—Ç —ç—Ö–æ-–ø–æ–≤—Ç–æ—Ä—ã —Å–ª–æ–≤"""
        try:
            # –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–ª–æ–≤–∞
            text = self.compiled_patterns['echo'].sub(r'\1', text)

            # –¢–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä—ã —Ç–∏–ø–∞ "—Å–ª–æ–≤–æ —Å–ª–æ–≤–æ —Å–ª–æ–≤–æ"
            words = text.split()
            if len(words) >= 3:
                cleaned_words = []
                i = 0
                while i < len(words):
                    current_word = words[i].lower()

                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –ø–æ–≤—Ç–æ—Ä–æ–º
                    if (i + 1 < len(words) and words[i + 1].lower() == current_word and
                        i + 2 < len(words) and words[i + 2].lower() == current_word):
                        # –¢—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–ª–æ–≤–∞ –ø–æ–¥—Ä—è–¥ - –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ
                        cleaned_words.append(words[i])
                        i += 3
                    elif (i + 1 < len(words) and words[i + 1].lower() == current_word):
                        # –î–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–ª–æ–≤–∞ - –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ
                        cleaned_words.append(words[i])
                        i += 2
                    else:
                        cleaned_words.append(words[i])
                        i += 1

                text = ' '.join(cleaned_words)

            return text

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–æ–≤: {e}")
            return text

    def _cleanup_formatting(self, text: str) -> str:
        """–û—á–∏—â–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–æ–≤"""
        try:
            # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
            text = re.sub(r'\s+', ' ', text)

            # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–µ—Ä–µ–¥ –∑–Ω–∞–∫–∞–º–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
            text = re.sub(r'\s+([.!?,:;])', r'\1', text)

            # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏—Ö —Å–∫–æ–±–æ–∫
            text = re.sub(r'([(])\s+', r'\1', text)

            # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö —Å–∫–æ–±–æ–∫ (–µ—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π —Å–∏–º–≤–æ–ª - –±—É–∫–≤–∞)
            text = re.sub(r'([)])\s*([–∞-—è—ëa-z])', r'\1 \2', text, flags=re.IGNORECASE)

            # –û—á–∏—â–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
            text = text.strip()

            # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–µ—Ä–µ–¥ –∏ –ø–æ—Å–ª–µ –∫–∞–≤—ã—á–µ–∫
            text = re.sub(r'\s*"\s*([^"]*)\s*"\s*', r'"\1"', text)
            text = re.sub(r"\s*'\s*([^']*)\s*'\s*", r"'\1'", text)

            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
            text = re.sub(r'([.!?])\1+', r'\1', text)  # !!! -> !
            text = re.sub(r',,+', ',', text)  # ,, -> ,

            # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–µ—Ä–µ–¥ % –∏ –ø–æ—Å–ª–µ —Ü–∏—Ñ—Ä
            text = re.sub(r'(\d)\s*%', r'\1%', text)

            # –û—á–∏—â–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤–æ–∫—Ä—É–≥ —Ç–∏—Ä–µ
            text = re.sub(r'\s*-\s*', '‚Äì', text)  # –ó–∞–º–µ–Ω—è–µ–º –¥–µ—Ñ–∏—Å –Ω–∞ —Ç–∏—Ä–µ

            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –≤–æ–∫—Ä—É–≥ —Ç–∏—Ä–µ
            text = re.sub(r'\s*‚Äì\s*', ' ‚Äì ', text)

            # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ—Å–ª–µ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
            text = re.sub(r'([.!?])\s*([–∞-—è—ëa-z])', lambda m: m.group(1) + ' ' + m.group(2).upper(),
                         text, flags=re.IGNORECASE)

            # –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
            text = re.sub(r'\s+', ' ', text)
            text = text.strip()

            return text

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
            return text

    def _aggressive_cleanup(self, text: str) -> str:
        """–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —á–∏—Å—Ç–æ—Ç—ã —Ç–µ–∫—Å—Ç–∞"""
        try:
            # –£–¥–∞–ª—è–µ–º –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞ (1-2 –±—É–∫–≤—ã), –∫—Ä–æ–º–µ –ø—Ä–µ–¥–ª–æ–≥–æ–≤
            short_words_to_keep = {'–≤', '—Å', '–∫', '–æ', '—É', '–∞', '–∏', '—è', '—Ç—ã', '–æ–Ω', '–º—ã', '–≤—ã', '—Ç–æ', '–Ω–µ', '–¥–∞', '–Ω–æ', '–ª–∏', '–∂–µ', '–±—ã', '–Ω–∏', '–≤–æ', '—Å–æ', '–∫–æ', '–¥–æ', '–ø–æ', '–æ–±', '–æ—Ç', '–∏–∑', '–Ω–∞'}

            words = text.split()
            filtered_words = []

            for word in words:
                word_lower = word.lower()
                # –û—Å—Ç–∞–≤–ª—è–µ–º —Å–ª–æ–≤–∞ –¥–ª–∏–Ω–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤ –∏–ª–∏ –≤–∞–∂–Ω—ã–µ –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞
                if len(word) > 2 or word_lower in short_words_to_keep:
                    filtered_words.append(word)

            return ' '.join(filtered_words)

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏: {e}")
            return text

    def add_filler_word(self, word: str):
        """–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ –≤ —Å–ø–∏—Å–æ–∫ –º–µ–∂–¥–æ–º–µ—Ç–∏–π"""
        try:
            self.filler_words.add(word.lower())
            self._compile_patterns()  # –ü–µ—Ä–µ–∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã
            self.logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω–æ –º–µ–∂–¥–æ–º–µ—Ç–∏–µ: {word}")
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ–∂–¥–æ–º–µ—Ç–∏—è: {e}")

    def remove_filler_word(self, word: str):
        """–£–¥–∞–ª—è–µ—Ç —Å–ª–æ–≤–æ –∏–∑ —Å–ø–∏—Å–∫–∞ –º–µ–∂–¥–æ–º–µ—Ç–∏–π"""
        try:
            self.filler_words.discard(word.lower())
            self._compile_patterns()  # –ü–µ—Ä–µ–∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã
            self.logger.info(f"–£–¥–∞–ª–µ–Ω–æ –º–µ–∂–¥–æ–º–µ—Ç–∏–µ: {word}")
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ–∂–¥–æ–º–µ—Ç–∏—è: {e}")

    def get_stats(self) -> Dict:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–µ—Ä–≤–∏—Å–∞"""
        return {
            "enabled": self.enabled,
            "aggressive_mode": self.aggressive_mode,
            "filler_words_count": len(self.filler_words),
            "echo_pattern": self.echo_pattern
        }
